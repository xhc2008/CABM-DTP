# Desktop Pet 重构说明

## 重构目标
将原本700多行的 `desktop_pet.py` 拆分成更小、更易维护的模块，提高代码的可读性和可维护性。

## 拆分结构

### 1. `threads.py` - 线程处理模块
- **AIResponseThread**: 处理AI响应的异步线程
- **VisionProcessThread**: 处理VLM图片描述的异步线程

**职责**: 
- 避免UI阻塞的异步任务处理
- AI聊天和视觉处理的后台执行

### 2. `system_tray.py` - 系统托盘模块
- **SystemTrayManager**: 管理系统托盘图标和菜单

**职责**:
- 系统托盘图标的创建和管理
- 托盘菜单的构建
- 托盘消息通知
- 显示/隐藏状态管理

### 3. `event_handler.py` - 事件处理模块
- **EventHandler**: 处理鼠标事件和窗口位置管理

**职责**:
- 鼠标拖拽事件处理
- 右键点击防抖机制
- 窗口位置变化检测
- 定时器管理

### 4. `desktop_pet.py` - 主窗口模块（重构后）
- **DesktopPet**: 核心桌面宠物类

**职责**:
- UI初始化和管理
- 各模块的协调
- 消息处理和AI交互
- 窗口生命周期管理

## 重构优势

1. **代码分离**: 每个模块专注于特定功能，职责清晰
2. **易于维护**: 修改某个功能时只需关注对应模块
3. **可重用性**: 各模块可以独立测试和重用
4. **可读性**: 代码结构更清晰，更容易理解
5. **扩展性**: 新功能可以作为独立模块添加

## 文件对比

| 原始文件 | 行数 | 重构后 | 行数 |
|---------|------|--------|------|
| desktop_pet.py | ~700 | desktop_pet.py | ~350 |
| - | - | threads.py | ~60 |
| - | - | system_tray.py | ~100 |
| - | - | event_handler.py | ~80 |
| **总计** | **700** | **总计** | **590** |

## 备份文件
- `desktop_pet_backup.py`: 原始文件的备份，以防需要回滚

## 使用方式
重构后的使用方式与原来完全相同，所有公共接口保持不变：

```python
from widgets.desktop_pet import DesktopPet

# 创建桌面宠物实例
pet = DesktopPet()
pet.show()
```

## 注意事项
- 所有原有功能保持不变
- 信号连接和事件处理逻辑保持一致
- 配置文件和依赖关系无变化