# 桌宠右键逻辑改进总结

## 改进内容

### 1. 新的右键行为逻辑

根据当前显示状态，右键桌宠本体会有不同的行为：

#### 状态1：启动后默认状态
- **当前状态**：只显示桌宠本体
- **右键行为**：显示文本输入框和选项栏

#### 状态2：输入框和选项栏已显示
- **当前状态**：桌宠本体 + 文本输入框 + 选项栏
- **右键行为**：隐藏文本输入框和选项栏

#### 状态3：消息气泡显示，选项栏也显示
- **当前状态**：桌宠本体 + 消息气泡 + 选项栏
- **右键行为**：只隐藏选项栏（保持消息气泡显示）

#### 状态4：消息气泡显示，选项栏隐藏
- **当前状态**：桌宠本体 + 消息气泡
- **右键行为**：打断消息气泡，显示文本输入框和选项栏

### 2. 防抖机制

- 添加了200ms的防抖延迟，避免误触发
- 使用QTimer实现防抖，确保在短时间内多次右键只执行一次操作

### 3. 消息显示逻辑改进

- 当开始AI回复时，自动隐藏输入框但保持选项栏显示
- 消息气泡显示期间，选项栏保持可见，方便用户操作

### 4. 选项栏"隐藏"按钮失效

- 禁用了选项栏的"隐藏"按钮
- 按钮变为灰色不可点击状态
- 添加了提示文字："请使用右键桌宠来隐藏"

## 技术实现细节

### 1. 核心方法

- `handle_right_click_action()`: 防抖后执行的右键处理逻辑
- `interrupt_message_and_show_input()`: 打断消息并显示输入界面
- `hide_options_panel()`: 只隐藏选项栏
- `show_input_window(hide_bubble=True)`: 显示输入窗口，可选择是否隐藏气泡

### 2. 状态检测

通过检查以下组件的可见性来判断当前状态：
- `input_window.isVisible()`: 输入框是否显示
- `options_panel.isVisible()`: 选项栏是否显示  
- `message_bubble.isVisible()`: 消息气泡是否显示

### 3. 线程管理

- 在打断消息时，正确终止AI响应线程
- 确保线程资源得到正确清理

### 4. 事件过滤器优化

- 修改了输入窗口的事件过滤器
- 避免与新的右键逻辑产生冲突
- 当检测到右键点击桌宠时，让桌宠的逻辑处理而不是直接关闭窗口

## 用户体验改进

1. **更直观的交互**：右键桌宠就能控制界面显示/隐藏
2. **智能状态切换**：根据当前状态智能决定下一步操作
3. **防误触**：200ms防抖避免意外操作
4. **保持一致性**：消息显示时保持选项栏可见，方便用户操作

## 测试验证

已通过逻辑测试验证所有状态转换的正确性：
- ✓ 默认状态 → 显示输入界面
- ✓ 输入界面显示 → 隐藏界面  
- ✓ 消息气泡显示 → 打断并显示输入界面
- ✓ 消息气泡+选项栏显示 → 只隐藏选项栏
- ✓ 异常状态处理正确

## 注意事项

1. 选项栏的"隐藏"按钮已失效，用户需要使用右键控制
2. 防抖机制可能会有轻微延迟感，但能有效防止误操作
3. 所有状态转换都经过测试，确保逻辑正确性